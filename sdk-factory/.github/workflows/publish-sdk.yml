name: Publish SDK to Maven

on:
  push:
    tags:
      - 'v*'  # 当推送tag时触发（如 v1.0.0）
  workflow_dispatch:  # 允许手动触发
    inputs:
      client:
        description: '客户ID (留空则发布所有)'
        required: false
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout代码
        uses: actions/checkout@v4
      
      - name: 设置JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: 设置Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: 安装依赖
        run: |
          pip install pyyaml
      
      - name: 赋予执行权限
        run: chmod +x gradlew scripts/build_sdk.py
      
      - name: 生成源码
        run: ./gradlew generateClientSources
      
      - name: 生成混淆规则
        run: ./gradlew generateProguardRules
      
      # ==================== 发布客户A ====================
      - name: 发布 Client A SDK
        if: github.event.inputs.client == '' || github.event.inputs.client == 'client-a'
        env:
          CLIENT_A_MAVEN_USERNAME: ${{ secrets.CLIENT_A_MAVEN_USERNAME }}
          CLIENT_A_MAVEN_PASSWORD: ${{ secrets.CLIENT_A_MAVEN_PASSWORD }}
        run: |
          python scripts/build_sdk.py --client client-a --publish
      
      # ==================== 发布客户B ====================
      - name: 发布 Client B SDK
        if: github.event.inputs.client == '' || github.event.inputs.client == 'client-b'
        env:
          CLIENT_B_MAVEN_USERNAME: ${{ secrets.CLIENT_B_MAVEN_USERNAME }}
          CLIENT_B_MAVEN_PASSWORD: ${{ secrets.CLIENT_B_MAVEN_PASSWORD }}
        run: |
          python scripts/build_sdk.py --client client-b --publish
      
      # ==================== 更多客户可以继续添加 ====================
      
      - name: 上传构建产物
        uses: actions/upload-artifact@v3
        with:
          name: sdk-artifacts
          path: |
            generated/*/build/outputs/aar/*.aar
            generated/*/build/outputs/mapping/*/mapping.txt

